#' Add_RegProb
#'
#' @param quantiles A numeric vector with no missing data with extreme air temperatures.
#' @param regional_pars A 5-column and 1-row `data.frame` or `matrix` as that generated by `reg_par()`.
#' @param site_temp A vector or 1-column matrix with site's air temperature (original) data.
#' @param n.year A single number describing the number of the year for which parameters are calculated.
#' @export
#' @importFrom extRemes pevd
#' @examples
#' quantiles <- c(39.5,39.8,40.1,40.3,40.4,40.5,40.6,41.0,41.7)
#' add.data <- Dataset_add(TmaxCPC_SP)
#' best.parms <- Best_model(add.data=add.data$add_data)
#' regional_pars <- Reg_par(best_model = best.parms$atsite.models)
#' Add_RegProb(quantiles=quantiles,
#'                   regional_pars=regional_pars,
#'                   site_temp=TmaxCPC_SP$Pixel_1,
#'                   n.year=34)

Add_RegProb <- function(quantiles, regional_pars, site_temp, n.year) {
  # Input checks
  if (!is.numeric(quantiles) || any(is.na(quantiles))) {
    stop("`quantiles` must be a numeric vector with no missing values.")
  }
  regional_pars <- as.matrix(regional_pars)
  if (!is.numeric(regional_pars) || ncol(regional_pars) != 5 || nrow(regional_pars) != 1) {
    stop("Input 'reg_par' must be a numeric data frame or matrix with 5 columns and 1 row.")
  }

  if (!is.numeric(site_temp) || length(site_temp) == 0) {
    stop("`site_temp` must be a non-empty numeric vector or 1-column matrix.")
  }

  if (!is.numeric(n.year) || length(n.year) != 1 || n.year < 1 || n.year > length(site_temp)) {
    stop("`n.year` must be a single number between 1 and the length of `site_temp`.")
  }

  max_time <- length(site_temp)
  site_mean <- mean(site_temp, na.rm = TRUE)
  time <- 1L:max_time
  selected.time <- time[n.year]
  add.quantiles <- quantiles - site_mean

  loc <- as.numeric(regional_pars[1] + regional_pars[2] * selected.time)
  scale <- as.numeric(regional_pars[3] + regional_pars[4] * selected.time)
  shape <- as.numeric(regional_pars[5])

  # Check for non-positive scale (GEV scale parameter must be positive)
  if (scale <= 0) {
    stop("Calculated scale parameter must be positive.")
  }

  RegProb <- as.matrix(extRemes::pevd(add.quantiles, loc = loc,
                                      scale = scale,
                                      shape = shape,
                                      type = c("GEV")))
  # Truncate probabilities
  RegProb[RegProb < 0.0001] <- 0.0001
  RegProb[RegProb > 0.9999] <- 0.9999

  return(RegProb)
}
